@page "/workouts"

@using FitnessTrackingApp.Models
@using FitnessTrackingApp.DTOs
@using FitnessTrackingApp.Interfaces

@inject IWorkoutService WorkoutService
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider

@rendermode InteractiveServer

<h1 class="text-4xl font-extrabold mb-6 text-black">Weekly Workout Planner</h1>

<div class="flex space-x-2 overflow-x-auto pb-2 border-b border-gray-700 mb-6">
    @foreach (var day in DaysOfWeek)
    {
        <button class="@GetDayButtonClasses(day)" @onclick="() => SelectDay(day)">
            @day: @DayToDate[day].ToString("dd MMM")
        </button>
    }
</div>

<button class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-xl shadow-lg hover:bg-blue-700 transition duration-150 ease-in-out mb-6"
        @onclick="OpenAddModal">
    + Add Workout
</button>

<div class="space-y-6">
    @if (GetWorkoutsForSelectedDay().Any())
    {
        @foreach (var workout in GetWorkoutsForSelectedDay())
        {
            <div class="p-6 rounded-3xl shadow-xl flex items-center justify-between border-l-8 border-blue-500 bg-gray-900 text-gray-100">
                <div class="flex-1 space-y-1">
                    <h2 class="text-2xl font-bold">@workout.ExerciseName</h2>
                    <p class="text-lg text-gray-300">
                        <span class="font-semibold text-blue-400">@workout.Sets</span> Sets
                        × <span class="font-semibold text-blue-400">@workout.Reps</span> Reps
                    </p>
                    <p class="text-sm text-gray-400">
                        Weight: @workout.WeightKg kg
                    </p>
                </div>

                <div class="flex space-x-2">
                    <button class="px-4 bg-yellow-500 hover:bg-yellow-600 text-white p-3 rounded-full transition"
                            @onclick="() => OpenEditModal(workout)">
                        ✎
                    </button>
                    <button class="px-4 bg-red-600 hover:bg-red-700 text-white p-3 rounded-full transition"
                            @onclick="() => OpenDeleteModal(workout)">
                        🗑
                    </button>
                </div>
            </div>
        }
    }
    else
    {
        <div class="text-center py-10 text-gray-500">
            <p class="text-xl">No workouts planned for @SelectedDay.</p>
            <p class="text-sm">Enjoy your rest day or add an exercise!</p>
        </div>
    }
</div>

@if (IsModalOpen)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-900 text-gray-100 rounded-lg p-6 w-96 shadow-2xl">
            <h2 class="text-xl font-bold mb-4">@ModalTitle</h2>

            <div class="space-y-3">
                <input class="w-full p-3 rounded-lg bg-gray-800 text-gray-100 border border-gray-700 focus:border-blue-500 outline-none"
                       placeholder="Exercise Name (e.g. Bench Press)" @bind="CurrentWorkout.ExerciseName" />

                <div class="flex space-x-2">
                    <input class="w-1/2 p-3 rounded-lg bg-gray-800 text-gray-100 border border-gray-700 focus:border-blue-500 outline-none"
                           placeholder="Sets" type="number" @bind="CurrentWorkout.Sets" />
                    <input class="w-1/2 p-3 rounded-lg bg-gray-800 text-gray-100 border border-gray-700 focus:border-blue-500 outline-none"
                           placeholder="Reps" type="number" @bind="CurrentWorkout.Reps" />
                </div>

                <input class="w-full p-3 rounded-lg bg-gray-800 text-gray-100 border border-gray-700 focus:border-blue-500 outline-none"
                       placeholder="Weight (kg)" type="number" step="0.1" @bind="CurrentWorkout.WeightKg" />

                <input class="w-full p-3 rounded-lg bg-gray-800 text-gray-100 border border-gray-700 focus:border-blue-500 outline-none"
                       type="date" @bind="CurrentWorkout.Date" />
            </div>

            <div class="mt-6 flex justify-end space-x-2">
                <button class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg transition" @onclick="CloseModal">Cancel</button>
                <button class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition" @onclick="SaveWorkout">Save</button>
            </div>
        </div>
    </div>
}

@if (IsDeleteModalOpen)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-900 text-gray-100 rounded-lg p-6 w-80 shadow-2xl">
            <h2 class="text-xl font-bold mb-4">Confirm Delete</h2>
            <p class="text-gray-300 mb-6">Are you sure you want to delete <strong>@WorkoutToDelete?.ExerciseName</strong>?</p>

            <div class="flex justify-end space-x-2">
                <button class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg transition" @onclick="CloseDeleteModal">Cancel</button>
                <button class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition" @onclick="ConfirmDeleteWorkout">Delete</button>
            </div>
        </div>
    </div>
}

@code {
    private List<FitnessTrackingApp.Models.Workout> AllWorkouts = new(); // Stores ALL fetched workouts
    private string UserId = string.Empty;

    // Week View Logic
    private string SelectedDay = "Mon";
    private Dictionary<string, DateTime> DayToDate = new();
    private string[] DaysOfWeek = new[] { "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun" };

    // Modal State
    private bool IsModalOpen = false;
    private bool IsDeleteModalOpen = false;
    private string ModalTitle = "Add Workout";
    private CreateWorkoutDto CurrentWorkout = new();
    private FitnessTrackingApp.Models.Workout? EditingWorkout = null;
    private FitnessTrackingApp.Models.Workout? WorkoutToDelete = null;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            UserId = user.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value ?? "";
        }

        // Initialize Week Dates
        var startOfWeek = DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek + 1); // Assuming Mon start
        if (DateTime.Today.DayOfWeek == DayOfWeek.Sunday) startOfWeek = DateTime.Today.AddDays(-6); // Fix for Sunday

        foreach (var day in DaysOfWeek.Select((d, i) => new { d, i }))
        {
            DayToDate[day.d] = startOfWeek.AddDays(day.i);
        }

        // Select today by default
        var todayStr = DateTime.Now.DayOfWeek.ToString().Substring(0, 3);
        if (DaysOfWeek.Contains(todayStr)) SelectedDay = todayStr;

        await LoadWorkouts();
    }

    private async Task LoadWorkouts()
    {
        // We fetch all workouts and filter in memory to keep UI snappy
        AllWorkouts = await WorkoutService.GetUserWorkoutsAsync(UserId);
    }

    private IEnumerable<FitnessTrackingApp.Models.Workout> GetWorkoutsForSelectedDay()
    {
        // Filter the main list based on the selected day's date
        var targetDate = DayToDate[SelectedDay].Date;
        return AllWorkouts.Where(w => w.Date.Date == targetDate);
    }

    private void SelectDay(string day)
    {
        SelectedDay = day;
        // No need to fetch from API again if we have all data, just re-render
    }

    private string GetDayButtonClasses(string day) =>
        day == SelectedDay
            ? "px-4 py-2 text-sm font-semibold rounded-full bg-blue-500 text-white shadow-lg transform scale-105 transition"
            : "px-4 py-2 text-sm font-medium rounded-full bg-gray-800 text-gray-300 hover:bg-gray-700 transition";

    private void OpenAddModal()
    {
        ModalTitle = "Add Workout";
        // Default date to the currently selected day in the week view
        CurrentWorkout = new CreateWorkoutDto { Date = DayToDate[SelectedDay] };
        EditingWorkout = null;
        IsModalOpen = true;
    }

    private void OpenEditModal(FitnessTrackingApp.Models.Workout workout)
    {
        ModalTitle = "Edit Workout";
        EditingWorkout = workout;

        CurrentWorkout = new CreateWorkoutDto
        {
            ExerciseName = workout.ExerciseName,
            Sets = workout.Sets,
            Reps = workout.Reps,
            WeightKg = workout.WeightKg,
            Date = workout.Date
        };

        IsModalOpen = true;
    }

    private void CloseModal()
    {
        IsModalOpen = false;
    }

    private async Task SaveWorkout()
    {
        if (EditingWorkout != null)
        {
            await WorkoutService.UpdateWorkoutAsync(EditingWorkout.Id, UserId, new UpdateWorkoutDto
            {
                ExerciseName = CurrentWorkout.ExerciseName,
                Sets = CurrentWorkout.Sets,
                Reps = CurrentWorkout.Reps,
                WeightKg = CurrentWorkout.WeightKg,
                Date = CurrentWorkout.Date
            });
        }
        else
        {
            await WorkoutService.CreateWorkoutAsync(UserId, CurrentWorkout);
        }

        IsModalOpen = false;
        await LoadWorkouts(); // Reload to refresh list
    }

    private void OpenDeleteModal(FitnessTrackingApp.Models.Workout workout)
    {
        WorkoutToDelete = workout;
        IsDeleteModalOpen = true;
    }

    private void CloseDeleteModal()
    {
        IsDeleteModalOpen = false;
        WorkoutToDelete = null;
    }

    private async Task ConfirmDeleteWorkout()
    {
        if (WorkoutToDelete != null)
        {
            await WorkoutService.DeleteWorkoutAsync(WorkoutToDelete.Id, UserId);
            IsDeleteModalOpen = false;
            await LoadWorkouts();
        }
    }
}